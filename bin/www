#!/usr/bin/env node

/**
 * Module dependencies.
 */

 var { app,sessionMiddleware } = require('../app');
 var debug = require('debug')('sotuken:server');
 var http = require('http');
 var express = require('express');
 const path = require('path');
 var ExcelJS = require('exceljs');
 var validator = require('validator');
 var fs = require('fs');
 var poolCluster = app.get('pool');
 var async = require('async');
 var crypto = require('crypto');
 const sha512 = crypto.createHash('sha512');
 const encoding = 'hex';
 const sanitizeHtml = require('sanitize-html');
 
 
 
 /**
  * Get port from environment and store in Express.
  */
 
 var port = normalizePort(process.env.PORT || '3000');
 app.set('port', port);
 
 /**
  * Create HTTP server.
  */
 var server = http.createServer(app);
 var { Server } =require("socket.io");
 var io = new Server(server);
 /**
  * Listen on provided port, on all network interfaces.
  */
 
 server.listen(port,'0.0.0.0', () => {console.log('サーバ起動しました。\nlistening on "[このサーバ機のIPアドレス]:3000"');});
 server.on('error', onError);
 server.on('listening', onListening);
 
 /**
  * Normalize a port into a number, string, or false.
  */
 
 function normalizePort(val) {
   var port = parseInt(val, 10);
 
   if (isNaN(port)) {
     // named pipe
     return val;
   }
 
   if (port >= 0) {
     // port number
     return port;
   }
 
   return false;
 }
 
 /**
  * Event listener for HTTP server "error" event.
  */
 
 function onError(error) {
   if (error.syscall !== 'listen') {
     throw error;
   }
 
   var bind = typeof port === 'string'
     ? 'Pipe ' + port
     : 'Port ' + port;
 
   // handle specific listen errors with friendly messages
   switch (error.code) {
     case 'EACCES':
       console.error(bind + ' requires elevated privileges');
       process.exit(1);
       break;
     case 'EADDRINUSE':
       console.error(bind + ' is already in use');
       process.exit(1);
       break;
     default:
       throw error;
   }
 }
 
 /**
  * Event listener for HTTP server "listening" event.
  */
 
 function onListening() {
   var addr = server.address();
   var bind = typeof addr === 'string'
     ? 'pipe ' + addr
     : 'port ' + addr.port;
   debug('Listening on ' + bind);
 }
 
 const mysql = require('mysql2');
 const store = require('store');
 const { connect } = require('http2');
 const { namespace } = require('store');
 const { param } = require('jquery');


  // Socket.ioにセッションミドルウェアを適用する
  io.use((socket, next) => {
      sessionMiddleware(socket.request, {}, next);
  });

 
 io.on('connection', (socket) => {//ページが繋がったとき
   console.log(socket.request.session);
   const mysql_setting = {
     host: 'localhost',
     user: 'root',
     password: '20010426',
     database: 'mydb2'
   }
   
   //password: 'ha031008',
   //password: '20021225',
   //password: '20010426',
   //password: 'matosui122083',
   
   const connection = mysql.createConnection(mysql_setting);
   connection.connect();

   socket.on('crypto1',(data) =>{
    sha512.update(data);
    var sha512Hash = sha512.digest(encoding);
    io.emit('crypto',sha512Hash); 
  })

  /*socket.on('new_btnclick', (name,pass1,pass2) => {
      if(pass1 == pass2) {
         var new_select1 = "select username from users where username = ?;"
         var new_select2 = "select password from users where password = ?;"
         var new_insert1 = "insert into users values (?,?,?,'2022{01>01','2022{01>01');"
         var kensaku = "SELECT MIN(user_ID + 1100) AS user_ID FROM users WHERE (user_ID + 1100) NOT IN (SELECT user_ID FROM users);"
         connection.query(new_select1,name,(err, new_result1, fields) => {
           connection.query(new_select2,pass1,(err, new_result2, fields) => {
             if(new_result1.length < 1 && pass1.length >= 8 && pass1.length <= 16 && pass1.length != 0 && name.length >= 2 && name.length <= 10) {
               connection.query(kensaku,(err,kensaku1,fields)=>{
                 if(err){
                   console.log(err);
                 }
                 e = e + 1;
               })
             })
           })
         }
         setTimeout(function(){
           callback(null,1);
         },1000);
       },
       function(callback){
         io.emit('yomikomi');
       })
     })*/

     socket.on('new_btnclick', (name,pass1,pass2) => {
      if(pass1 == pass2) {
        var new_select1 = "select username from users where username = ?;"
        var new_select2 = "select password from users where password = ?;"
        var new_insert1 = "insert into users values (?,?,?,'2022{01>01','2022{01>01');"
        var kensaku = "SELECT MIN(user_ID + 1100) AS user_ID FROM users WHERE (user_ID + 1100) NOT IN (SELECT user_ID FROM users);"
        connection.query(new_select1,name,(err, new_result1, fields) => {
          connection.query(new_select2,pass1,(err, new_result2, fields) => {
            if(new_result1.length < 1 && pass1.length >= 8 && pass1.length <= 16 && pass1.length != 0 && name.length >= 2 && name.length <= 10) {
              connection.query(kensaku,(err,kensaku1,fields)=>{
                if(err){
                  console.log(err);
                }
                var user = kensaku1[0].user_ID;
                connection.query(new_insert1,[user,name,pass1],(err, new_result3, fields) => {
                  if(err){
                    console.log(err);
                  }
                  var new_flug = 1;
                  io.emit('new_flug',new_flug);
              })
              })
            }
          })
        })
      }
    })

     socket.on('filedata',(data) =>{
      var q1 = "insert into mondai_LIST values(?,?,?,?,?,?,?,?,?,?,?);"
      var q2 = "select MIN(mon_ID  + 1) AS mon_ID from mondai_LIST where (mon_ID + 1) NOT IN (SELECT mon_ID from mondai_LIST);"
      var q3 = "select MIN(seikai_ID  + 1) AS seikai_ID from seikai_LIST where (seikai_ID + 1) NOT IN (SELECT seikai_ID from seikai_LIST);"
      var q4 = "insert into seikai_LIST values(?,?,?);"
      var da = "a";
      var moni = 0;
      var name = data[0];
      var mondaibun = data[1];
      var sen1 = data[2];
      var sen2 = data[3];
      var sen3 = data[4];
      var sen4 = data[5];
      var seikai = data[6];
      var seiID = 0;
      var kaiID = 0;
      if(data[7] != "なし"){
        var picture = data[7];
      }else{
        var picture = "";
      }
      connection.query(q2,(err,result,field)=>{
        if(err){
          console.log(err);
        }
        moni = result[0].mon_ID;
        if(sen1 == "なし"){
          sen1 = "";
          sen2 = "";
          sen3 = "";
          sen4 = "";
          kaiID = 1;
        }
        connection.query(q3,(err,result2,field)=>{
            if(err){
              console.log(err);
            }
            seiID = result2[0].seikai_ID;
            connection.query(q4,[seiID,moni,seikai],(err,result3,field)=>{
              if(err){
                console.log(err);
              }
              connection.query(q1,[moni,name,mondaibun,sen1,sen2,sen3,sen4,seiID,0,picture,kaiID],(err,res1,fields)=>{
                if(err){
                  console.log(err);
                }
                connection.commit((err) =>{
                  if(err){connection.rollback(() =>{throw console.log('error');});};
                  io.emit('kanryou');
            })
            })
          })
      })
    })  
    })
    
   //myoujin
   /* socket.on('montuika',(array)=>{
     var q1 = "insert into mondai_LIST values(?,?,?,?,?,?,?,?,?,?,?);"
     var q2 = "select MIN(mon_ID  + 1) AS mon_ID from mondai_LIST where (mon_ID + 1) NOT IN (SELECT mon_ID from mondai_LIST);"
     var q3 = "select MIN(seikai_ID  + 1) AS seikai_ID from seikai_LIST where (seikai_ID + 1) NOT IN (SELECT seikai_ID from seikai_LIST);"
     var q4 = "insert into seikai_LIST values(?,?,?);"
     var da = "a";
     console.log(array);
     var moni = 0;
     var name = array[0];
     var mondaibun = array[1];
     var sen1 = array[2];
     var sen2 = array[3];
     var sen3 = array[4];
     var sen4 = array[5];
     var seikai = array[6];
     var seiID = 0;
     var kaiID = 0;
     if(sen1 == "なし"){
       sen1 = "";
       sen2 = "";
       sen3 = "";
       sen4 = "";
       kaiID = 1;
     }
     if(array[7] != "なし"){
       var picture = array[7];
     }else{
       var picture = "";
     }
     connection.query(q2,(err,res,field)=>{
       if(err){
         console.log(err);
       }
       moni = res[0].mon_ID;
       connection.query(q3,(err,res2,field)=>{
         if(err){
           console.log(err);
         }
         seiID = res2[0].seikai_ID;
         connection.query(q4,[seiID,moni,seikai],(err,res3,field)=>{
           if(err){
             console.log(err);
           }
           connection.query(q1,[moni,name,mondaibun,sen1,sen2,sen3,sen4,seiID,0,picture,kaiID],(err,res4,field)=>{
             if(err){
               console.log(err);
             }
             connection.commit((err) =>{
               if(err){connection.rollback(() =>{throw console.log('error');});};
               io.emit('kanryou');
             })  
           })
         })
       })
     })
   })
   
    socket.on('syokika',()=>{
       var sql1="truncate table time_LIST;"
       var sql2="truncate table kaitou_LIST;"
       var sql3="update mondai_LIST set sentaku= 0 where sentaku = 1"
       var sql4 = "truncate table monhan_LIST";
       connection.query(sql1,(err,result1,fields)=>{
        if(err){
          console.log(err);
        }
        connection.query(sql2,(err,result2,fields)=>{
          if(err){
            console.log(err);
          }
          connection.query(sql3,(err,results2,fields)=>{
            if(err){
              console.log(err);
            }
            connection.query(sql4,(err,result4,fields)=>{
              if(err){
                console.log(err);
              }
              io.emit('modoru');
            })
          })
        })
       })
    })
  
    socket.on('hyou',(c) =>{
        io.emit('hyouji',c);
      })
  
    socket.on('kekkahyouji',()=>{
        io.emit('kekkahyouji2');
    })
    
    // login
    socket.on('login_btnclick', (login_name,login_pass1) => {
          
          if(login_pass1 != '') {
            var login_select1 = "select username from users where username = ?;"
            var login_select2 = "select password from users where password = ?;"
            var login_select3 = "select password from users where username = ?;"
            var login_select4 = "select user_ID from users where username = ?;"
            connection.query(login_select1,login_name,(err, login_result1, fields) => {
              if(err){
                console.log(err);
                var new_flug = 0;
                io.emit('new_flug',new_flug);
              }
              connection.query(login_select2,login_pass1,(err, login_result2, fields) => {
                if(err){
                  console.log(err);
                  var new_flug = 0;
                  io.emit('new_flug',new_flug);
                }
                if(login_result1.length >= 1 && login_result2.length >= 1) {
                  connection.query(login_select3,login_name,(err, login_result3, fields) => {
                    if(login_result3[0].password == login_pass1) {
                      if(err){
                        console.log(err);
                        var new_flug = 0;
                        io.emit('new_flug',new_flug);
                      }
                      connection.query(login_select4,login_name,(err,login_result4,fields) =>{
                        if(err){
                          console.log(err);
                          var new_flug = 0;
                          io.to(token).emit('new_flug',new_flug);
                        }
  
                        if(login_result4[0].user_ID < 100)
                        {
                          var login_flug = 1;
                          io.to(socket.id).emit('login_flug',login_flug,login_name);
                        }else if(login_result4[0].user_ID > 100 && login_result4[0].user_ID < 9999)
                        {
                          var login_flug = 1;
                          io.to(socket.id).emit('login_flug1',login_flug,login_name);
                        }else if(login_result4[0].user_ID > 10000)
                        {
                          var login_flug = 1;
                          io.to(socket.id).emit('login_flug2',login_flug,login_name);
                        }
                      })
                    }else{
                      var new_flug=0;
                      io.to(socket.id).emit('new_flug',new_flug);
                    }
                  })
                }
              })
          })
        }
      })
  
          socket.on('owa2',() =>{
            io.emit('owari');
          })
  
      socket.on('mondai_btnclick',(mondai,o) => {
      
        if(mondai != ''){
          var pool = poolCluster.of('MASTER');
          var mondai_select = "select mon_ID,mondaibun from mondai_LIST where sentaku = 1;"
          let mondai_sentaku = "update mondai_LIST set sentaku = '1' where name = ?;"
          let sql3 = "insert into monhan_LIST values(?,?);"
          let sql4 = "select han_ID from hankeisiki_LIST where han_keisiki = ?;"
          pool.getConnection(function(err,connection){
            if(err != null){
              console.log(err);
              return;
            }
            connection.query(mondai_sentaku,mondai,(err,mondai_result,fields) =>{
              console.log(err);
              connection.query(mondai_select,(err,mondai_result2,fields)=>{
                if(err){
                var flag = 0;
                io.emit('mondai_kekka',flag);
              }
              connection.commit((err) =>{
                if(err){connection.rollback(() =>{throw console.log('error');});}
              })
              var ID = mondai_result2[0].mon_ID;
              connection.query(sql4,o,(err,result,fields) =>{
                if(err){
                  console.log(err);
                }
                var han1 = result[0].han_ID;
                connection.query(sql3,[ID,han1],(err,result,fields)=>{
                  if(err){
                    console.log(err);
                  }
                })
              })
              var flag = 1;
              io.emit('mondai_kekka',flag);
              })
            })
          })*/

    socket.on('kekkasyusei',(set1)=>{
      var userID = socket.request.session.user.username;
      var sql = "update answer_table set result = ? where user_ID =?;"
      async.waterfall([
        function(callback) {
          // 最初のステップとして、全ての更新操作を行う
          async.eachSeries(set1, function(selection, cb) {
            var userID = selection.user_ID; // オブジェクトのプロパティへのアクセス
            var selectedValue = selection.selectedValue; //オブジェクトのプロパティへのアクセス   
            connection.query(sql, [selectedValue, userID], (err, result) => {
              if (err) {
                console.log(err);
                return cb(err); // エラーを次のステップへ渡す
              }
              console.log("Update successful for user_ID: ", userID);
              cb(); // 次の要素へ
            });
          }, function(err) {
            if (err) {
              // 更新中にエラーが発生した場合
              callback(err, null);
            } else {
              // すべての更新が成功した場合
              callback(null, 'All updates completed successfully');
            }
          });
        }
      ], function(err, result) {
        // 全ての処理が完了した後の最終的なコールバック
        if (err) {
          console.log('An error occurred: ', err);
          // 必要に応じてエラーハンドリングをここに書く
        } else {
          // すべての更新操作が成功したことをクライアントに通知
          io.emit('result_display2', {username:userID});
        }
      });
    })

    socket.on('kaitoutuika', (selections) => {
      var userID = socket.request.session.user.username;
      async.eachSeries(selections, function(selection, cbEachSeries) {
        var correctID, questionID;
        async.waterfall([
          // Step 1: correct_IDを検索して取得する
          function(callback) {
            var sql = "SELECT MIN(correct_ID + 1) AS correct_ID FROM correct_table WHERE (correct_ID + 1) NOT IN (SELECT correct_ID FROM correct_table);";
            connection.query(sql, (err, result) => {
              if (err) return callback(err);
              correctID = result[0].correct_ID;
              callback(null);
            });
          },
          // Step 2: question_genreからquestion_IDを持ってくる
          function(callback) {
            var sqlFindQuestionID = "SELECT question_ID FROM question_table WHERE question_name = ?";
            connection.query(sqlFindQuestionID, [selection.questionGenre], (err, result) => {
              if (err) return callback(err);
              if (result.length === 0) return callback(new Error("Question ID not found for genre: " + selection.questionGenre));
              questionID = result[0].question_ID;
              callback(null);
            });
          },
          // Step 3: correct_tableにINSERTする
          function(callback) {
            var sqlInsert = "INSERT INTO correct_table (correct_ID, question_ID, answer) VALUES (?, ?, ?)";
            connection.query(sqlInsert, [correctID, questionID, selection.answer], (err, result) => {
              if (err) return callback(err);
              callback(null);
            });
          },
          // Step 4: 追加した正解に対応した答えのresultを○に変更する
          function(callback) {
            var sqlUpdateResult = "UPDATE answer_table SET result = '○' WHERE question_ID = ? AND answer = ?";
            connection.query(sqlUpdateResult, [questionID, selection.answer], (err, result) => {
              if (err) return callback(err);
              callback(null, "Update successful for question_ID: " + questionID + " with answer: " + selection.answer);
            });
          }
        ], function(err, result) {
          // selectionごとの処理完了後のコールバック
          if (err) {
            console.log(err);
            return cbEachSeries(err);
          }
          console.log(result);
          cbEachSeries(); // 次のselectionへ
        });
      }, function(err) {
        // 全てのselectionsが処理された後のコールバック
        if (err) {
          console.log("An error occurred in the process.");
        } else {
          console.log("All selections processed successfully.");
          io.emit('yomikomi', {username: userID}); // 処理完了をクライアントに通知
        }
      });
    });
    
        
      
   
      socket.on('kaitousakuzyo', (deletions) => {
        var userID = socket.request.session.user.username;
        var sqlDelete = "DELETE FROM correct_table WHERE answer = ?;";
        var sqlUpdate = "UPDATE answer_table SET result = '✕' WHERE answer = ?;";
        
        async.eachSeries(deletions, function(deletion, callback) {
            // 正解を削除
            connection.query(sqlDelete, [deletion.answer], (err, result) => {
                if (err) {
                    console.log(err);
                    return callback(err);
                }
                // 関連する回答の結果を更新
                connection.query(sqlUpdate, [deletion.answer], (err, result) => {
                    if (err) {
                        console.log(err);
                        return callback(err);
                    }
                    callback(); // 次の削除処理に進む
                });
            });
        }, function(err) {
            if (err) {
                // エラーが発生した場合の処理
                console.error("エラーが発生しました: ", err);
            } else {
                // すべての処理が成功した場合の処理
                io.emit('yomikomi',{username: userID}); // クライアントに完了を通知
            }
        });
    });
  
     
     socket.on('montuika',(array)=>{
      var q1 = "insert into mondai_LIST values(?,?,?,?,?,?,?,?,?,?,?);"
      var q2 = "select MIN(mon_ID  + 1) AS mon_ID from mondai_LIST where (mon_ID + 1) NOT IN (SELECT mon_ID from mondai_LIST);"
      var q3 = "select MIN(seikai_ID  + 1) AS seikai_ID from seikai_LIST where (seikai_ID + 1) NOT IN (SELECT seikai_ID from seikai_LIST);"
      var q4 = "insert into seikai_LIST values(?,?,?);"
      var da = "a";
      console.log(array);
      var moni = 0;
      var name = array[0];
      var mondaibun = array[1];
      var sen1 = array[2];
      var sen2 = array[3];
      var sen3 = array[4];
      var sen4 = array[5];
      var seikai = array[6];
      var seiID = 0;
      var kaiID = 0;
      if(sen1 == "なし"){
        sen1 = "";
        sen2 = "";
        sen3 = "";
        sen4 = "";
        kaiID = 1;
      }
      if(array[7] != "なし"){
        var picture = array[7];
      }else{
        var picture = "";
      }
    })

     socket.on('kiroku',(m1,kaitou1) =>{
  
      let monname = 'select m.mon_ID,s.seikai from mondai_LIST m ,seikai_LIST s where sentaku = 1 and m.mon_ID = s.mon_ID;'
      let seikai = 'select kaitou from mondai_LIST where sentaku = 1;'
      let tuika = 'insert into kaitou_LIST values(?,?,?,?);'
      let userIDSELECT = 'select user_ID from users where username = ?;'
      let update1 = "update kaitou_LIST set user_ID = ? where user_ID = '9999';"
      var hantei = "✕";
      connection.query(monname,(err,result,fields)=>{
        if(err){
          console.log(err);
        }
        var idi = result[0].mon_ID;
        for(var i = 0;i<result.length;i++){
          if(kaitou1 == result[i].seikai){
            hantei = "○";
          }
        }
          var addsqlparams = ['9999',idi,kaitou1,hantei];
          connection.query(tuika,addsqlparams,(err,result,fields) =>{
            if(err){
            console.log(err);
          }
          connection.commit((err) =>{
            if(err){connection.rollback(() =>{throw console.log('error');});}
          })
          connection.query(userIDSELECT,m1,(err,result_user,fields)=>{
            if(err){
              console.log(err);
            }
            var user_I = result_user[0].user_ID
            connection.query(update1,user_I,(err,result_user2,fields)=>{
              if(err){
                console.log(err);
              }
              io.emit('owari');
            })
          })

         /* })
        })
     })

     socket.on('all_commit',()=>{
      connection.commit((err) =>{
        if(err){connection.rollback(() =>{throw console.log('error');});}
        connection.release();
      })
     })
  });*/

        })
      })
    })
    
     socket.on('clear',()=>{
        var userID = socket.request.session.user.username;
        var sql1="select room_ID from room_table where user_ID =?;"
        var sql2="select question_ID from question_log where room_ID =? and question_status = 1;"
        var sql3="update question_log set question_status = 0 where question_status = 1 and room_ID = ? and question_ID =?;"
        var sql4 ="select distinct user_ID from login_log where user_ID <> ? and room_ID =?;";
        var sql5 ="DELETE FROM answer_table WHERE user_ID = ? and question_ID =?;"
        var sql6 ="DELETE FROM judge_table where question_ID =?;"
        console.log(userID);
        async.waterfall([
          function(callback){
              connection.query(sql1,userID,(err,result,field)=>{
                if(err){
                  console.log(err);
                }
                console.log("成功");
                console.log(result[0].room_ID);
                callback(null,userID,result[0].room_ID);
              })
          },
          function(userID,roomID,callback){
            connection.query(sql2,roomID,(err,res2,field)=>{
              if(err){
                console.log(err);
              }
              console.log("成功");
              console.log(res2[0].question_ID);
              callback(null,userID,roomID,res2[0].question_ID);
            })
          },
          function(userID,roomID,questionID,callback){
            connection.query(sql3,[roomID,questionID],(err,result3,field)=>{
              if(err){
                console.log(err);
              }
            })
            console.log("成功");
            callback(null,userID,roomID,questionID);
          },
          function(userID,roomID,questionID,callback){
            connection.query(sql4,[userID,roomID],(err,result4,field)=>{
              if(err){
                console.log(err);
              }
              console.log("成功");
              console.log(result4);
              callback(null,userID,roomID,questionID,result4);
            })
          },
          function(userID,roomID,questionID,student,callback){
            async.eachSeries(student, function(students, cb) {
              connection.query(sql5, [students.user_ID, questionID], (err, result5, field) => {
                  if (err) {
                      console.log(err);
                      return cb(err); // エラーをコールバックに渡す
                  }
                  console.log("成功");
                  cb(); // 次のイテレーションへ進むためにコールバックを呼び出す
              });
          }, function(err) {
              // すべてのクエリが完了した後、またはエラーが発生した場合に実行される
              if (err) {
                  // エラー処理
                  return callback(err);
              }
              // すべて成功した場合の処理
              callback(null, userID, roomID, questionID);
          });
          },
          function(userID,roomID,questionID,callback){
            connection.query(sql6,questionID,(err,result6,field)=>{
              if(err){
                console.log(err);
              }
              console.log("成功");
              callback(null,userID,roomID,questionID)
            })
          },
          function(userID,roomID,questionID,callback){
            socket.emit('modoru');
          }
        ])
     })
   
     socket.on('hyou',(c) =>{
         io.emit('hyouji',c);
      })
   
     socket.on('result_display',()=>{
        const username = socket.request.session.user.username;
        io.emit('result_display2',{username:username});

     })
     
     // login
     socket.on('login_btnclick', (data) => {
      var username = sanitizeHtml(data.username);
      var password = sanitizeHtml(data.password);
      if(data.ExcelJSusername != '') {
          var login_select = "SELECT * FROM user_table;";
          connection.query(login_select,(err, users, fields) => {
              if(err){
                  console.log(err);
                  var new_flug = 0;
                  //io.emit('new_flug', new_flug);
                  io.emit('login_error');
              } else {
                  var user = users.find(user => user.user_ID === username && user.password === password);
                  if(user) {
                      var login_flug = 1;
                      switch(user.user_type) {
                          case 1:
                              async.waterfall([
                                function(callback) {
                                    var sql2 = 'SELECT room_ID FROM room_table WHERE user_ID = ?;';
                                    connection.query(sql2, data.username, function(err, result) {
                                        if (err) {
                                            return callback(err);
                                        }
                                        callback(null, result[0].room_ID);
                                    });
                                },
                                function(roomID, callback) {
                                    var sql3 = 'INSERT INTO login_log(room_ID, user_ID) VALUES (?, ?);';
                                    connection.query(sql3, [roomID, data.username], function(err, result) {
                                        if (err) {
                                            return callback(err);
                                        }
                                        callback(null, 'done');
                                    });
                                },
                                function(result,callback){
                                  socket.request.session.user = {username:username};
                                  socket.request.session.page = 2;                      // ページ番号を直接保存
                                  socket.request.session.Before_page = 1; 
                                  socket.request.session.save();
                                  console.log(socket.request.session);
                                  callback(null,'done');
                                }
                            ], function (err, result) {
                                if (err) {
                                    console.log(err);
                                    var new_flug = 0;
                                    io.emit('new_flug', new_flug);
                                } else {
                                    // すべてのクエリが成功した場合の処理
                                    io.to(socket.id).emit('login_flug', login_flug, data.username);
                                }
                            });
                              break;
                          case 2:
                            async.waterfall([
                              function(callback){
                                var sql = 'SELECT user_ID FROM user_table WHERE user_name = ?;';
                                connection.query(sql,data.selectedOption, function(err, result) {
                                    if (err) {
                                        return callback(err);
                                    }
                                    callback(null, result[0].user_ID);
                                });
                              },
                              function(userID,callback) {
                                var sql2 = 'SELECT room_ID FROM room_table WHERE user_ID = ?;';
                                connection.query(sql2,userID, function(err, result) {
                                    if (err) {
                                        return callback(err);
                                    }
                                    callback(null, result[0].room_ID);
                                });
                              },
                              function(roomID,callback) {
                                  var sql3 = 'INSERT INTO login_log(room_ID, user_ID) VALUES (?, ?);';
                                  connection.query(sql3, [roomID, data.username], function(err, result) {
                                      if (err) {
                                          return callback(err);
                                      }
                                      callback(null, 'done');
                                  });
                              }
                            ], function (err, result) {
                              if (err) {
                                  console.log(err);
                                  io.emit('login_error');
                              } else {
                                  // すべてのクエリが成功した場合の処理
                                  io.to(socket.id).emit('login_flug1', login_flug,user.user_name);
                              }
                          });
                              break;
                          case 3:
                              async.waterfall([
                                function(callback){
                                  var sql = 'SELECT user_ID FROM user_table WHERE user_name = ?;';
                                  connection.query(sql,data.selectedOption, function(err, result) {
                                      if (err) {
                                          return callback(err);
                                      }
                                      callback(null, result[0].user_ID,username);
                                  });
                                },
                                function(user_ID,username,callback){
                                  var sql = "select room_ID from room_table where user_ID = ?;";
                                  connection.query(sql,user_ID,(err,result,fields)=>{
                                    if(err){
                                      console.log(err);
                                    }
                                    callback(null,result[0].room_ID,username);
                                  })
                                },
                                function(roomID,username,callback){
                                  var sql2 = "insert into login_log(room_ID,user_ID) values(?,?);"
                                  connection.query(sql2,[roomID,username],(err,result2,fields)=>{
                                    if(err){
                                      console.log(err);
                                    }
                                    io.to(socket.id).emit('login_flug2', login_flug,username);
                                  })
                                },
                              ])
                              break;
                          default:
                              var new_flug = 0;
                              io.to(socket.id).emit('new_flug', new_flug);
                      }
                  } else {
                      io.to(socket.id).emit('login_error');
                  }
              }
          });
      }
  });
   
        socket.on('account_delete',(user_ID)=>{
          var sql = "delete from user_table where user_ID = ?;";
          connection.query(sql,user_ID,(err,result,field)=>{
            if(err){
              console.log(err);
            }
            io.emit('delete_complete');
          })
        })

        socket.on('search_accounts', function(searchTerm) {
          const sql = 'SELECT user_ID, user_name, password,log_time FROM user_table WHERE user_ID LIKE ? OR user_name LIKE ? OR password LIKE ?';
          connection.query(sql, [`%${searchTerm}%`, `%${searchTerm}%`, `%${searchTerm}%`], function(err, results) {
              if (err) {
                  // エラー処理
                  console.log(err);
                  socket.emit('search_results', []);
              } else {
                  // 検索結果をクライアントに送信
                  socket.emit('search_results', results);
              }
          });
      });

      socket.on('add_account', function(formData) {
        if(formData.user_type == "学生"){
          var user_typeID = 2
        }else{
          var user_typeID = 2
        }
        var sql = 'insert into user_table(user_ID,user_name,password,user_type) values(?,?,?,?)'
        connection.query(sql,[formData.user_ID,formData.user_name,formData.pass_word,user_typeID],(err,result,field)=>{
          if(err){
            console.log(err);
            socket.emit('account_added');
          }
        })
      });
    
      socket.on('owa2',() =>{
         io.emit('owari');
      })


      socket.on('pageupdate',(page_update_No) =>{
        switch(page_update_No){
          case 1:
            socket.request.session.Before_page = "before_main.ejs"
            socket.request.session.page = "next_mondai.ejs"
            socket.request.session.save();
            io.emit('page_updatecomplete'); 
            break;
        }
      })
   
       socket.on('mondai_btnclick',(mondai,o) => {
       
         if(mondai != ''){
           var pool = poolCluster.of('MASTER');
           var mondai_select = "select q.question_ID,q.question_text from question_table q,question_log l where l.question_ID = q.question_ID AND q.question_status = 1 AND l.room_ID = 1;" //選択した問題SQL
           let mondai_sentaku = "insert into question_log(question_id,room_id,question_status) VALUES (?,1,1) ;"  //出題問題SQL
           let sql3 = "insert into judge_table(judge_ID,question_ID) values(?,?);" 
           let sql4 = "select judge_ID from judge_type where judge_type = ?;"  //判定形式SQL
           let get_id_sql = "select question_ID from question_table where question_name=?;"
           let get_status = "select count(*) as cnt from question_log where room_ID = 1 AND question_status = 1;"
           let question_reset = "update question_log set question_status = 0 WHERE room_id = 1;"

           pool.getConnection(function(err,connection){
             if(err != null){
               console.log("db" + err);
               return;
             }
             connection.query(get_status,(err,status_count,fields) =>{
              if(err){
                console.log("wawawa" + err);
                return;
              }
              console.log("count" + status_count[0].cnt);
              if(status_count[0].cnt >= 1){
                console.log("count" + status_count[0].cnt);
                connection.query(question_reset,(err,fields) =>{
                  if(err){
                    console.log("reset " + err);
                    return;
                  }else{
                    console.log("リセット");
                    connection.query(get_id_sql,mondai.question_name,(err,question_id,fields) =>{
                  if(err){
                    console.log(err);
                  }
                  var q_ID = question_id[0].question_ID;
                  connection.query(mondai_sentaku,q_ID,(err,mondai_result,fields) =>{
                    if(err){
                      console.log("sentaku_err" + err);
                    }
                    connection.commit((err) =>{if(err){connection.rollback(() =>{throw console.log('error');});}})
                    connection.query(mondai_select,(err,mondai_result2,fields)=>{
                      if(err){
                        var flag = 0;
                        io.emit('mondai_kekka',flag);
                      }
                      connection.commit((err) =>{
                        if(err){connection.rollback(() =>{throw console.log('error');});}
                      })
                      var ID = mondai_result2[0].question_ID;
                      connection.query(sql4,o,(err,result,fields) =>{
                        if(err){
                          console.log("sql4 "+err);
                        }
                        var han1 = result[0].judge_ID;
                        connection.query(sql3,[han1,ID],(err,result,fields)=>{
                          if(err){
                            console.log("sql3 "+err);
                          }
                        })
                      })
                        var flag = 1;
                        io.emit('mondai_kekka',flag);
                        })
                      })
                    })
                  }
                })
              }else{
                console.log("naiyo--");
                connection.query(get_id_sql,mondai,(err,question_id,fields) =>{
                  if(err){
                    console.log(err);
                  }
                  var q_ID = question_id[0].question_ID;
                  connection.query(mondai_sentaku,q_ID,(err,mondai_result,fields) =>{
                    if(err){
                      console.log("sentaku_err" + err);
                    }
                      connection.commit((err) =>{
                      if(err){connection.rollback(() =>{throw console.log('error');});}
                    })
                    connection.query(mondai_select,(err,mondai_result2,fields)=>{
                      if(err){
                      var flag = 0;
                      io.emit('mondai_kekka',flag);
                    }
                    connection.commit((err) =>{
                      if(err){connection.rollback(() =>{throw console.log('error');});}
                    })
                    var ID = mondai_result2[0].question_ID;
                    connection.query(sql4,o,(err,result,fields) =>{
                      if(err){
                        console.log("sql4 "+err);
                      }
                      var han1 = result[0].judge_ID;
                      connection.query(sql3,[han1,ID],(err,result,fields)=>{
                        if(err){
                          console.log("sql3 "+err);
                        }
                      })
                    })
                    var flag = 1;
                    io.emit('mondai_kekka',flag);
                    })
                  })
                 })
              }
            })
          })
        }
      })

      /*socket.on('mondai_btnclick',(question_data) => {
        console.log(question_data.userName);
       if(question_data != ''){
         var pool = poolCluster.of('MASTER');
         //
         //データベースサーバーに接続
         async.waterfall([
           function(callback) {
             pool.getConnection(function(err, connection) {
                 if (err) {
                     console.log(err);
                     return callback(err);
                 }
                 callback(null, connection);
             });
           },
           function(connection,callback) {
             var mondai_select = "select q.question_ID,r.room_ID,j.judge_ID from question_table q,room_table r,judge_type j where q.question_name = ? and judge_type = ? and r.user_ID = ?;"
             connection.query(mondai_select, [question_data.question_name,question_data.Scoring_method,question_data.userName], function(err, selectResult) {
                 if (err) {
                     connection.release();
                     console.log(err);
                     return callback(err);
                 }
                 callback(null, connection,selectResult);
             });
           },
           function(connection,selectResult,callback) {
             let judge_insert = "insert into judge_table values (?, ?);";
             let questionID = selectResult[0].question_ID;
             let roomID = selectResult[0].room_ID;
             let judgeID = selectResult[0].judge_ID;
             connection.query(judge_insert, [judgeID,questionID], function(err, result) {
                 if (err) {
                     connection.release();
                     console.log(err);
                     return callback(err);
                 }
                 callback(null, connection, questionID, roomID);
             });
           },
           function(connection, questionID, roomID, callback) {
             let sql3 = "insert into question_log(question_ID, room_ID, question_status, limit_time) values (?, ?, 1, ?);";
             connection.query(sql3, [questionID, roomID,question_data.seconds], function(err, result) {
                 if (err) {
                     connection.release();
                     console.log(err);
                     return callback(err);
                 }
                 connection.release();
                 callback(null, 'success');
             });
           }
         ],function(err,result){
           if (err) {
             io.emit('mondai_kekka', 0);
           } else {
             io.emit('mondai_kekka', 1);
           }
         })
      }
    })*/

      socket.on('kiroku',(m1,kaitou1) =>{
   
        var pool = poolCluster.of('MASTER');
        async.waterfall([
          function(callback){
            pool.getConnection(function(err, connection) {
              if (err) {
                  console.log(err);
                  return callback(err);
              }
              callback(null, connection);
            });
          },
          function(connection,callback){
            var sql = 'select room_ID from login_log where user_ID = ?;';
            connection.query(sql,m1,(err,result,fields)=>{
              if(err){
                console.log(err);
              }
              var room = result[0].room_ID;
              callback(null,room);
            })
          },
          function(room,callback){
            var select = 'select question_ID from question_log where room_ID = ? and question_status = 1;';
            connection.query(select,room,(err,result2,field)=>{
              if(err){
                console.log(err);
              }
              var question = result2[0].question_ID;
              callback(null,question);
            })
          },
          function(question,callback){
            var correct = 'select answer from correct_table where question_ID = ?';
            connection.query(correct,question,(err,result3,fields)=>{
              if(err){
                console.log(err);
              }
              var correct_data = result3[0].answer;
              console.log(correct_data);
              callback(null,correct_data,question);
            })
          },
          function(correct_data,question,callback){
            var judgement = "✕";
            if(kaitou1 == correct_data){
              judgement = "○";
            }
            callback(null,question,judgement);
          },
          function(question,judgement,callback){
            var insert = "insert into answer_table(user_ID,question_ID,answer,ans_pics_flag,result) values(?,?,?,0,?);";
            connection.query(insert,[m1,question,kaitou1,judgement],(err,result4,fields)=>{
              if(err){
                console.log(err);
              }
              callback(null,"success");
            })
          }
        ],function(err,result5){
          if(err){

          }else{
            socket.emit('end');
          }
        })
      })
 
      socket.on('all_commit',()=>{
       connection.commit((err) =>{
         if(err){connection.rollback(() =>{throw console.log('error');});}
         connection.release();
       })
      })

      socket.on('requestQualificationData',function(qualificationName){
        var sql = 'select g.question_genre,g.question_years,q.question_name from question_table q,genre_table g where g.qualification_name = ? and q.question_ID = g.question_ID;';
        connection.query(sql,qualificationName,(err,result,fields)=>{
          if(err){
            console.log(err);
          }
          socket.emit('qualificationData', result);
        });
      })

      socket.on('requestquestionname',function(qualificationName){
        var sql = 'select g.question_genre,q.question_name from question_table q,genre_table g where g.question_years = ? and q.question_ID = g.question_ID;';
        connection.query(sql,qualificationName,(err,result,fields)=>{
          if(err){
            console.log(err);
          }
          socket.emit('questionname', result);
        });
      })

      socket.on('requestgenre',function(qualificationName){
        var sql = 'select g.question_genre from question_table q,genre_table g where q.question_name = ? and q.question_ID = g.question_ID;';
        connection.query(sql,qualificationName,(err,result,fields)=>{
          if(err){
            console.log(err);
          }
          socket.emit('questiongenre', result);
        });
      })


      socket.on('logout',function(){
        socket.request.session.destroy(function(err) {
          if (err) {
              console.error("セッション破棄中にエラーが発生しました。", err);
              return res.status(500).send("セッションの破棄に失敗しました。");
          }
          socket.emit('logout_complete');
        });
      })
   });

